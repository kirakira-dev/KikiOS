name: Build KikiOS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-qemu:
    name: Build for QEMU
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          make \
          qemu-system-arm \
          mtools \
          dosfstools
    
    - name: Verify toolchain
      run: |
        aarch64-linux-gnu-gcc --version
        aarch64-linux-gnu-ld --version
        qemu-system-aarch64 --version
    
    - name: Build kernel
      run: make TARGET=qemu
    
    - name: Build userspace
      run: make user
    
    - name: Create disk image
      run: make disk
    
    - name: List build outputs
      run: |
        ls -la build/
        ls -la kikios_root/bin/ | head -20
    
    - name: Upload kernel binary
      uses: actions/upload-artifact@v4
      with:
        name: kikios-qemu-kernel
        path: build/kikios.bin
        if-no-files-found: error
    
    - name: Upload disk image
      uses: actions/upload-artifact@v4
      with:
        name: kikios-qemu-disk
        path: kikios.img
        if-no-files-found: error
    
    - name: Upload full build
      uses: actions/upload-artifact@v4
      with:
        name: kikios-qemu-full
        path: |
          build/kikios.bin
          build/kikios.elf
          kikios.img
          kikios_root/
        if-no-files-found: warn

  build-pi:
    name: Build for Raspberry Pi Zero 2W
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          make \
          mtools \
          dosfstools
    
    - name: Verify toolchain
      run: |
        aarch64-linux-gnu-gcc --version
        aarch64-linux-gnu-ld --version
    
    - name: Build kernel for Pi
      run: make TARGET=pi
    
    - name: Build userspace
      run: make user
    
    - name: List build outputs
      run: |
        ls -la build/
    
    - name: Upload Pi kernel
      uses: actions/upload-artifact@v4
      with:
        name: kikios-pi-kernel
        path: build/kernel8.img
        if-no-files-found: error
    
    - name: Upload Pi build
      uses: actions/upload-artifact@v4
      with:
        name: kikios-pi-full
        path: |
          build/kernel8.img
          build/kikios.elf
          kikios_root/
        if-no-files-found: warn

  release:
    name: Create Release (on tag)
    runs-on: ubuntu-latest
    needs: [build-qemu, build-pi]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download QEMU artifacts
      uses: actions/download-artifact@v4
      with:
        name: kikios-qemu-full
        path: qemu-build
    
    - name: Download Pi artifacts
      uses: actions/download-artifact@v4
      with:
        name: kikios-pi-full
        path: pi-build
    
    - name: Create release archives
      run: |
        cd qemu-build && zip -r ../kikios-qemu.zip . && cd ..
        cd pi-build && zip -r ../kikios-pi.zip . && cd ..
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          kikios-qemu.zip
          kikios-pi.zip
          qemu-build/build/kikios.bin
          pi-build/build/kernel8.img
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
